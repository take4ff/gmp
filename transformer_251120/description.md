v1
### 1. モデルアーキテクチャ： 「局所」と「大局」の同時学習
単なるTransformerではなく、ウイルスの進化特性に特化した**ハイブリッド・アーキテクチャ**を構築しました。

* **並列（残差）構造の採用**:
    * **意図**: 「今、どの変異が起きたか（事実）」と「どういう流れで起きたか（文脈）」の両方を鮮明に学習させるため。
    * **実装**: 共起集約層（現在の状態）と Causal Conv1D（直前の文脈）を**並列**に配置し、足し合わせる（Add）ことで、情報の劣化を防ぎつつ特徴を強化しました。
* **最新トレンドの導入 (SOTA)**:
    * **意図**: 学習の安定化と収束速度の向上。
    * **実装**: 活性化関数を `ReLU` から **`GeLU`** に変更し、正規化を **`Pre-Norm`** 構成に変更しました（GPT-3やLLaMAなどの現代的なLLMの構成）。

### 2. データ処理： リッチな生物学的特徴量の統合
文字列データを単なる記号としてではなく、意味のある**マルチモーダル情報**としてモデルに与える設計にしました。

* **8つのカテゴリカル特徴量**:
    * `[bef, pos, aft, codon_pos, aa_bef, aa_aft, prot_pos, region]`
    * **意図**: 塩基レベルだけでなく、アミノ酸レベル、コドンレベル、タンパク質領域レベルの情報を同時に与えることで、モデルが「変異の意味」を多角的に理解できるようにしました。
* **5つの数値特徴量**:
    * `[freq, hydro, charge, size, blsm]`
    * **意図**: アミノ酸の物理化学的性質の変化（疎水性や電荷など）を数値として与え、変異による構造的・機能的な影響を定量的に学習させます。
* **ID管理の厳格化**:
    * **意図**: CUDAエラーの回避。
    * **実装**: `config.py` の `VOCAB_SIZE` を「最大ID + 1」に修正し、`dataset.py` との不整合を解消しました。

### 3. 評価戦略： 厳密な時系列スプリット
「未来の情報をカンニングしない」という鉄則を守りつつ、モデルの性能を多角的に評価する仕組みにしました。

* **時系列による完全分離**:
    * **訓練**: 1〜40ステップ（過去）
    * **評価**: 38〜40ステップ（重複期間での適合度確認）
    * **テスト**: 41以降のステップ（完全な未知の未来）
    * **意図**: シャッフルを行わず、時間軸に沿って分割することで、実際のパンデミック予測と同じ条件下で評価を行います。
* **共起の評価指標**:
    * **意図**: 複数同時変異の予測評価。
    * **実装**: 「予測したTop-Kの集合」と「実際に起きた共起変異の集合」の積集合（AND）を取り、1つでも合っていれば正解とする現実的な指標を採用しました。

### 4. エンジニアリング： 試行錯誤の高速化
重厚なデータ処理を効率化し、研究のサイクルを早めるための機能を実装しました。

* **キャッシュシステムの導入**:
    * **意図**: 毎回数分〜数十分かかる「特徴量生成（アミノ酸変換や物性値計算）」をスキップするため。
    * **実装**: `cache_utils.py` と `pickle` を使い、設定（ハッシュ値）が変わらない限り、前処理済みのデータを再利用します。
* **変数の整合性確保**:
    * **意図**: バグの温床を排除。
    * **実装**: `SEQ_LEN` vs `MAX_SEQ_LEN` などの表記ゆれを統一し、`main.py` で未定義変数が参照されるエラーを修正しました。

---

**総括：**
この実装により、**「生物学的に妥当なリッチなデータを、最新のAIアーキテクチャで学習し、科学的に正しい方法で評価する」**ための強固な基盤が完成しました。これで安心して実験（学習）を開始できます。

**memo**
予測対象増やしたい(ablationは削除必須)、main.pyをより整理

---
v2
### 1. モデルアーキテクチャ： 「局所」と「大局」のハイブリッド学習
ウイルスの進化には、「直前の変異からの流れ」と「過去の変異との長期的な相互作用」の両方が重要であるという仮説に基づいています。

* **並列（残差）構造の採用**:
    * **Co-occurrence Attention**: 同時に起きた変異セットを集約し、「その時点の状態」を定義します。
    * **Causal Conv1D (Parallel Branch)**: 直近のタイムステップ（$t-2, t-1, t$）の連続性を学習し、「局所的な文脈」を抽出します。
    * **残差結合 (Add)**: 上記2つを足し合わせることで、**「変異そのものの情報」を薄めることなく、「文脈情報」を付与**してTransformerに渡します。
* **SOTA技術による安定化**:
    * 活性化関数に **GeLU**、正規化に **Pre-Norm** を採用し、現代的なLLMと同様の学習安定性を確保しました。

### 2. データパイプライン： 高速化と生物学的整合性の両立
膨大なゲノムデータを扱うための効率性と、生物学的な正確さを両立させました。

* **Pandas排除と辞書化**:
    * データ参照をPythonネイティブな辞書/リストに置き換え、特徴量生成のボトルネックを解消しました。
* **インクリメンタル・キャッシュ**:
    * 処理をバッチ単位で分割・保存することで、計算の中断・再開を可能にしました。これにより、数時間かかる処理のリスクを最小化しています。
* **マルチモーダル入力**:
    * 塩基情報だけでなく、**アミノ酸、コドン、領域、物理化学的性質（疎水性など）**を統合し、モデルが変異の「意味」を解釈できるようにしました。

### 3. 学習戦略： パラメータ調整の自動化
人間によるハイパーパラメータ調整の手間を減らし、モデルの最適化能力を高めました。

* **MultiTaskLoss (Uncertainty Weighting)**:
    * 「領域予測」と「位置予測」の損失バランスを、モデルの不確実性に基づいて**自動調整**させます。これにより、学習の進度に合わせて最適な重みが適用されます。
* **学習率スケジューラ (Cosine Annealing)**:
    * 学習率を動的に変化させることで、局所解へのトラップを防ぎ、より良い精度への収束を促します。

### 4. 評価・実験管理： 科学的な妥当性の確保
「何が起きたか」を正確に把握し、実験結果の信頼性を担保する仕組みです。

* **厳密な時系列スプリット**:
    * 訓練・評価・テストデータを時間軸で完全に分離し、未来の情報を参照しない（リーケージのない）公平な評価を行います。
* **詳細なメトリクスとAblation**:
    * 単純な正解率だけでなく、**Recall, Precision, F1** を計算します。
    * `config` で特徴量をマスクする機能により、「化学的性質は本当に効いているのか？」といった要因分析（Ablation Study）が可能です。
* **WandB とログ保存**:
    * 実験の推移を可視化し、使用した株（Strain）や予測結果の詳細をすべてファイルに残すことで、再現性と分析の容易さを確保しました。

---

この構成で、**「実験の準備」は完全に整いました**。
まずはこの設定で学習を回し、ベースラインとなる結果を確認することをお勧めします。

---
評価指標
-----

### 1\. 実験設定（アブレーションスタディ）一覧表

この表に基づき、`config.py` の設定を変更して複数の実験を行い、結果を比較します。
\*\*「Base Model（全部入り）」\*\*を基準とし、そこから特定の機能を削除した際の性能低下幅を確認します。

| 実験ID | 実験名称 | 変更する設定 (config / model) | 検証する仮説 |
| :--- | :--- | :--- | :--- |
| **Exp-0** | **Base Model (提案手法)** | **全てON** (並列Conv1D, GeLU, PreNorm, 全特徴量, MultiTaskLoss) | **提案する最強構成のベースライン性能。** |
| Exp-1 | w/o Causal Conv1D | `HierarchicalTransformer` 内の `x_context` 加算を削除 | 「直近の文脈（連続性）」の学習が精度に寄与しているか？ |
| Exp-2 | w/o Multi-modal | `ABLATION_MASKS['CHEM_FEATURES'] = True`<br>`['CODON_POS'] = True` 等 | 化学的性質やコドン情報といった「ドメイン知識」が本当に必要か？ |
| Exp-3 | w/o Co-occurrence | `ABLATION_MASKS['CO_OCCURRENCE'] = True` | 共起変異を特別扱い（Attention集約）することの有効性。 |
| Exp-4 | w/o MultiTaskLoss | `USE_MULTITASK_LOSS = False` (固定重み 0.5:0.5) | 損失の自動調整が学習安定化や精度向上に寄与しているか？ |
| Exp-5 | Architecture Legacy | `activation="relu"`, `norm_first=False` | GeLUやPre-NormといったSOTA技術の導入効果。 |
| Exp-6 | w/o Strain Info | 株（Strain）によるフィルタリングや考慮を外す | 株ごとの特性差が予測に与える影響。 |

-----

### 2\. 定量評価指標（Metrics）一覧表

モデルの出力（ログ）から収集し、比較すべき数値項目です。

| 評価項目 | 指標 (Metrics) | 意味・目的 | 重要度 |
| :--- | :--- | :--- | :--- |
| **予測精度** | **Position Hit Rate @1** | 厳密に「ズバリその位置」を予測できた割合（Top-1）。 | ★★★ (最重要) |
| | **Position Hit Rate @5** | 候補5個の中に正解が含まれる割合（Recall@5）。実用上の参考値。 | ★★☆ |
| | **Region Hit Rate @1** | 具体的な位置は外しても、「どのタンパク質領域か」は合っていた割合。 | ★★☆ |
| **不均衡対応** | **Position F1-Score** | 適合率(Precision)と再現率(Recall)の調和平均。変異なし(0)に偏っていないかの確認。 | ★★★ |
| **学習品質** | **Validation Loss** | 未知データに対する汎化性能。低いほど良い。 | ★★☆ |
| | **Convergence Epoch** | 何エポック目でベストモデルが保存されたか（収束速度）。 | ★☆☆ |

-----

### 3\. 定性評価（Qualitative Analysis）項目

数値だけでは見えない「モデルの振る舞い」を評価するための項目です。保存された `test_predictions.csv` を見て確認します。

| 評価観点 | 確認内容 | 期待される結果 |
| :--- | :--- | :--- |
| **スパイク変異の捕捉** | S領域（重要領域）での変異予測精度は高いか？ | 他の領域よりもS領域の変異（感染力に関わる）を優先して当ててほしい。 |
| **共起の再現** | 複数の変異が同時に正解となっているケースがあるか？ | `[(S, 501), (S, 484)]` のような共起パターンをセットで予測できていること。 |
| **化学的性質の寄与** | 化学的性質をOFFにした(Exp-2)際、どのような変異が予測できなくなったか？ | 電荷や疎水性が大きく変わるような「無理のある変異」の予測精度が落ちていれば、化学特徴量が効いている証拠。 |
| **未知株への対応** | テストデータ（未来）に含まれる新しい株（Strain）に対しても予測できているか？ | 訓練データにないパターンの変異にもある程度追従できているか。 |

-----

### 実行手順の提案

1.  まず **Exp-0 (Base Model)** を実行し、結果を記録します。これが基準になります。
2.  次に、**Exp-2 (w/o Multi-modal)** を実行します。これが最も興味深い比較（生物学的特徴量の意味）になるはずです。
3.  その後、時間の許す範囲で他のAblation実験を行い、表を埋めていきます。

論文やレポートにまとめる際は、**「Exp-0 が他のすべての設定よりも優れている（あるいは特定の要素が特出した効果を持っている）」** ことを表とグラフで示すのがゴールになります。